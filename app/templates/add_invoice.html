{% extends 'base.html' %}

{% block title %}
Add Invoice
{% endblock title %}

{% block body %}

<center><h1>Add Invoice</h1></center>

<br>

<div class="container">
    <form class="row g-3">
          
          <div class="col-md-6 form-floating">
            
            <input type="text" class="form-control" id="getcustomername" placeholder="Customer Name" list="customer_names">
            <label for="floatingPassword">Customer Name</label>
          </div>

          <datalist id="customer_names">
            {% for x in context.all_customers %}

            <option value="{{x.id}}">{{x.customer_name}} {{x.customer_place}}</option>
            {% endfor %}
        </datalist>

          <div class="col-md-6 form-floating">
            <input type="number" class="form-control" id="customer_mobile_no" placeholder="Customer Mobile Number" disabled>
            <label for="floatingPassword">Customer Mobile Number</label>
          </div>
  
          <div class="col-md-6 form-floating">
            <input type="text" class="form-control" id="customer_place" placeholder="Customer Place" disabled>
            <label for="floatingPassword">Customer Place</label>
          </div>

          <div class="col-md-6 form-floating">
            <input type="text" class="form-control" id="customer_gst_no" placeholder="Customer GST Number" disabled>
            <label for="floatingPassword">Customer GST Number</label>
        </div>

        <div class="col-md-3 form-floating">
            <input type="text" class="form-control" id="" placeholder="Parcel Details">
            <label for="floatingPassword">Parcel Details</label>
        </div>
        <div class="col-md-3 form-floating">
            <input type="number" class="form-control" id="" placeholder="Total Parcel">
            <label for="floatingPassword">Total Parcel</label>
            </div>

          <div class="col-md-3 form-floating">
            <input type="number" class="form-control" value="{{context.fetch_last_invoice_no}}" id="" placeholder="Invoice Number">
            <label for="floatingPassword">Invoice Number</label>
            </div>
            <div class="col-md-3 form-floating">
                <input type="date" class="form-control" value="{{context.today_invoice_date}}" id="" placeholder="Date">
                <label for="floatingPassword">Date</label>
            </div>
            
        <button type="button" onclick="add_products_btn()" class="btn btn-primary">Add Products</button>
        <button type="button" class="btn btn-primary">Add Products Manually</button>
        
        <center><h2>Products Details</h2></center>
        <div class="table-responsive">
          <table class="table table-bordered border-primary add_products_table">
            <thead>
              <tr>
                <th scope="col">ACTIONS</th>
                <th scope="col">SR NO</th>
                <th scope="col">PARTICULARS</th>
                <th scope="col">QTY</th>
                <th scope="col">PRICE (₹)</th>
                <th scope="col">TOTAL (₹)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><button type="button" class="btn btn-danger">Remove</button></td>
                <td>1</td>
                <td><input type="text" style="width: fit-content" class="form-control border-secondary"></td>
                <td><input type="text" style="width: fit-content" class="form-control border-secondary"></td>
                <td><input type="text" style="width: fit-content" class="form-control border-secondary"></td>
                <td><input type="text" style="width: fit-content" class="form-control border-secondary"></td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <center><h2>Invoice Amount Details</h2></center>
        <div class="table-responsive">
          <table class="table table-bordered border-primary">
            <thead>
              <tr>
                <th scope="col">SUB TOTAL (₹)</th>
                <th scope="col">DISCOUNT (%)</th>
                <th scope="col">DISCOUNT (₹)</th>
                <th scope="col">FINAL BILL (₹)</th>

              </tr>
            </thead>
            <tbody>
              <tr>
                <!-- Your table rows go here -->
              </tr>
            </tbody>
          </table>
        </div>
        
      </form>
</div>


<!--Add Products Modal  -->

<div class="modal fade" tabindex="-1" id="add_products_modal">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Select Products</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form class="d-flex" role="search">
          <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
          <button class="btn btn-outline-success" type="submit">Search</button>
        </form>
        <table class="table">
          <thead>
            <tr>
              <th scope="col">Actions</th>
              <th scope="col">Sr No.</th>
              <th scope="col">Product Name</th>
              <th scope="col">Product Price</th>
            </tr>
          </thead>
          <tbody>
            {% for item in context.all_products %}
            <tr class="select_row">
              <th scope="row"><button type="button" id="{{item.id}}" value="{{item.id}}" class="btn btn-secondary select_btn">Select</button></th>
              <td>{{loop.index}}</td>
              <td>{{item.product_name}}</td>
              <td>{{item.product_price}}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>


<script>
  // Fetch customer name 

        $(document).ready(function () {
        // this is the name from ((Input)) with datalist
        var DeptValue = document.getElementById('getcustomername');
        console.log(DeptValue.value)
        // Adding Event Listener to get the value	
        DeptValue.addEventListener('input', function () {
          if (!isNaN(DeptValue.value) && DeptValue.value % 1 === 0 && DeptValue.value.trim() !== "")  {
            $.get(`/get_single_customer_from_id/${DeptValue.value}`,
                function (data) {
                    // data = JSON.parse(data)
                    // console.log(data)
                    $("#getcustomername").val(data["customer_name"]);
                    $("#customer_place").val(data["customer_place"]);
                    $("#customer_mobile_no").val(data["mobile_no"]);
                    $("#customer_gst_no").val(data["gst_no"]);
                })
              } else {
                // $("#getcustomername").val("");
                    $("#customer_place").val("");
                    $("#customer_mobile_no").val("");
                    $("#customer_gst_no").val("");
              }
        });
    });

        // Add Products Modal show Function 

        function add_products_btn() {
          $('#add_products_modal').modal("show");
        }

  // select & deselect product in model 

  $(document).ready(function() {
  // When a table row is clicked
  $('.select_row').click(function() {
    // Toggle the 'table-success' class on the clicked row
    $(this).toggleClass('table-success');

    // Toggle the 'selected' class on the "Select" button inside the clicked row
    var isRowSelected = $(this).hasClass('table-success');
    $(this).find('.select_btn').toggleClass('btn-success', isRowSelected);
    $(this).find('.select_btn').text(isRowSelected ? 'Selected' : 'Select');

    // Get the values from the clicked row
    var srNo = $(this).find('td:nth-child(2)').text();
    var productName = $(this).find('td:nth-child(3)').text();
    var productPrice = $(this).find('td:nth-child(4)').text();

    // Display the values (you can replace this with your logic)
    console.log('Clicked Row Values:');
    console.log('Sr No: ' + srNo);
    console.log('Product Name: ' + productName);
    console.log('Product Price: ' + productPrice);
  });

  // When the "Select" button is clicked
  $('.select_btn').click(function(event) {
    // Stop the click event from propagating to the table row
    event.stopPropagation();

    // Toggle the 'table-success' class on the corresponding row
    var row = $(this).closest('tr');
    row.toggleClass('table-success');

    // Toggle the 'selected' class on the clicked "Select" button
    var isRowSelected = row.hasClass('table-success');
    $(this).toggleClass('btn-success', isRowSelected);
    $(this).text(isRowSelected ? 'Selected' : 'Select');

    // Get the values from the corresponding row
    var srNo = row.find('td:nth-child(2)').text();
    var productName = row.find('td:nth-child(3)').text();
    var productPrice = row.find('td:nth-child(4)').text();

    // Display the values (you can replace this with your logic)
    console.log('Clicked "Select" Button Values:');
    console.log('Sr No: ' + srNo);
    console.log('Product Name: ' + productName);
    console.log('Product Price: ' + productPrice);
  });
});

</script>

<style>
  /* Add pointer cursor for table rows and "Select" buttons in product model */
  table tbody tr, .select_btn {
    cursor: pointer;
  }
  
</style>
{% endblock body %}